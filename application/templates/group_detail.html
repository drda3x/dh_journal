{% extends "base.html" %}

{% block head %}

    <link rel="stylesheet" href="../static/css/group_detail.css" />

    <style>

    {% for color_class in passes_color_classes %}

        .{{ color_class.name }} {
            background-color: {{ color_class.val }};
        }

    {% endfor %}

    </style>

    <script type="text/javascript" src="/static/js/matrix.js"></script>
    <script type="text/javascript" src="/static/js/popover.js"></script>

{% endblock %}

{% block body %}

    {{ group_detail.name }}
    <br>
    {{ group_detail.start_date }}

    <table id="journal" class="table table-bordered">
        <tr>
            <th>
                Фамилия Имя
            </th>
            {% for date in group_detail.calendar %}
                <th class="hover-able">{{ date }}</th>
            {% endfor %}
        </tr>
        {% for student in group_detail.students %}
            <tr  data-stid="{{ student.person.id }}" class="student_row">
            <td class="hover-able fio_cell">{{ student.person.first_name }} {{ student.person.last_name }}</td>
            {% for date in student.calendar %}
                <td class="hover-able {{ date.color }}" data-date="{{ date.date }}" data-pass="{{ date.pass }}">
                {% if date.pass %}
                    <strong>{{ date.sign }}</strong>
                {% else %}
                    {{ date.sign }}
                {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
    </table>

    <a href="#addStudent" role="button" class="btn" data-toggle="modal">Добавить ученика</a>

    <!-- Форма добавления ученика в группу -->

    <div id="addStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить ученика в группу</h3>
        </div>
        <form class="form-horizontal" action="/group/addstudent">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="last_name">Фамилия</label>
                        <div class="controls">
                            <input type="text" name="last_name" id="last_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="first_name">Имя</label>
                        <div class="controls">
                            <input type="text" name="first_name" id="first_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="phone">Тел.</label>
                        <div class="controls">
                            <input type="tel" name="phone" id="phone" value="+712345678"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="e_mail">E-mail</label>
                        <div class="controls">
                            <input type="email" name="e_mail" id="e_mail" value="t@e.st">
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить">
            </div>
        </form>
    </div>


    <!-- Форма редактирования занятия -->
    <div id="lesson_window" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4><span id="lesson_window_date"></span> - {{ group_detail.name }}</h4>
        </div>
        <div>
            <table id="lesson_content" class="table table-bordered"></table>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Сохранить</button>
        </div>
    </div>

    <!-- Форма выбора абонемента -->
    <div id="pass_menu" class="modal hide">
        <div>
            {% for p in pass_detail %}
                <div class="control-group">
                    <label class="radio">
                        <input type="radio" name="select_pass_type" value="{{ p.id }}">
                        {{ p.name }}
                    </label>
                </div>
            {% endfor %}
            <div class="control-group">
                <label class="radio">
                    <input id="not_self_pay" type="radio" name="select_pass_type" value="-1">
                    Списать с другого абонемента
                </label>
                <div id="pass_menu_advanced" style="display: none">
                    <input id="pass_menu_fio" type="text" placeholder="Фамилия Имя">
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">

        (function() {

            var matrix = new window.View.Matrix();

            /**
             * Получить дату из колонки
             * @param element
             * @returns {*}
             */
            function getDateFromColumn(element) {
                return matrix.getColumn(element)[0].text();
            }

            /**
             * Заполнить попап урока
             * @param context
             */
            function fillLessonsForm(context) {
                var $this = $('#lesson_window'),
                    $date = $('#lesson_window_date'),
                    names = matrix.getColumn(0),
                    lesson = matrix.getColumn(context),
                    container = $('#lesson_content'),
                    popoverLogic = new window.vidgetsLogic.Popover();

                container.empty();
                $date.text(getDateFromColumn(context));
                container.append('<tr><th>Фамилия Имя</th><th>Присутствие</th></tr>');

                for(var i= 1, j= names.length; i<j; i++) {
                    var tr = $('<tr>'),
                        name = $('<td>').append(names[i].html()),
                        state = $('<td>&nbsp;</td>');

                    state.attr('class', lesson[i].attr('class'));

                    // Удаляем следы hover-эффекта от родительской таблицы
                    state.removeClass('active');
                    state.removeClass('highlight');

                    // В зависимости от наличия абонемента подставляется разный контент
                    if(lesson[i].data('pass') === 'True') {
                        state.append(
                            $('<input type="checkbox" style="margin: 0" />')
                        );

                        state.click(function(event) {
                            var $target = $(event.target);

                            if(!$target.is('input')) {
                                var cb = $(this).children().first();

                                if(cb.prop('checked')) {
                                    cb.removeAttr('checked');
                                } else {
                                    cb.prop('checked', 'checked');
                                }
                            }
                        });

                    } else {

                        state.addClass('add-pass');

                        popoverLogic.init(state);

                        state.click(function() {
                            popoverLogic.hide();
                            popoverLogic.show($(this));
                        });

                    }

                    tr.append(name);
                    tr.append(state);

                    tr.appendTo(container);
                }
            }

            // Add DOM events
            var cl = $('.hover-able');

            cl.mouseenter(function(event) {

                var $this = $(this);

                if($this.hasClass('fio_cell')) {
                    if(!$(this).hasClass('active')) $this.addClass('highlight');
                } else {
                    if(!$(this).hasClass('active')) matrix.highlightColumn($(this));
                }

            });

            cl.mouseleave(function() {

                var $this = $(this);

                if($this.hasClass('fio_cell')) {
                    if(!$(this).hasClass('active')) $this.removeClass('highlight');
                } else {
                    if(!$(this).hasClass('active')) matrix.unHighlightColumn($(this));
                }

            });

            var tr = $('#journal tr');

            tr.click(function(event) {

                var $this = $(event.target);

                if($this.hasClass('hover-able')) {

                    matrix.deactivateAll();

                    if(!$this.hasClass('fio_cell')) {
                        matrix.deactivateAll();
                        matrix.makeActive(event.target);
                    } else {
                        $this.addClass('highlight');
                        $this.addClass('active');
                    }

                }
            });

            tr.dblclick(function(event) {
                var $this = $(event.target),
                    date = getDateFromColumn($this);

                if($this.hasClass('hover-able')) {

                    fillLessonsForm($this);

                    if (!$this.hasClass('fio_cell')) {
                        $('#lesson_window').modal('show');
                    }
                }

            });

        })();
    </script>

{% endblock %}