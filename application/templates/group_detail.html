{% extends "base.html" %}

{% block head %}

    <link rel="stylesheet" href="../static/css/group_detail.css" />

    <style>

    {% for color_class in passes_color_classes %}

        .{{ color_class.name }} {
            background-color: {{ color_class.val }};
        }

    {% endfor %}

    </style>

    <script type="text/javascript" src="/static/js/matrix.js"></script>
    <script type="text/javascript" src="/static/js/popover.js"></script>
{% endblock %}

{% block body %}

    <div class="journal-header">
        <strong class="text-info">Группа: </strong>{{ group_detail.name }}
        <span id="infoLastLesson"><strong class="text-info" style="margin: 0 0 0 10px;">Последнее занятие: </strong>01.06.2015</span>
        <span id="infoStartDate" style="display: none;"><strong  class="text-info" style="margin: 0 0 0 10px;">Дата начала: </strong>{{ group_detail.start_date }}</span>
    </div>
    <ul class="nav nav-tabs" id="navTab">
        <li class="active"><a id="journalNav" href="#journal-tc" data-toggle="tab">Ведомость</a></li>
        <li><a id="infoNav" href="#info" data-toggle="tab">Группа</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="journal-tc">
            <table id="journal" class="table table-bordered table-striped">
                <tr>
                    <th>
                        Фамилия Имя
                    </th>
                    {% for date in group_detail.calendar %}
                    <th class="hover-able">{{ date }}</th>
                    {% endfor %}
                </tr>
                {% for student in group_detail.students %}
                <tr  data-stid="{{ student.person.id }}" class="student_row">
                    <td class="hover-able fio_cell">{{ student.person.last_name }} {{ student.person.first_name }}</td>
                    {% for date in student.calendar %}
                    <td class="hover-able {{ date.color }}" data-date="{{ date.date }}" data-pass="{{ date.pass }}">
                        {% if date.pass %}
                        <strong>{{ date.sign }}</strong>
                        {% else %}
                        {{ date.sign }}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>

        <div class="tab-pane" id="info">
            <table class="table table-bordered table-striped table-hover">
                <tr>
                    <th class="info-fio"><input class="student-selector" type="checkbox" value="-1" /></th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Телефон</th>
                    <th>E-mail</th>
                    <th>ОРГ-статус</th>
                    <th>Остаток по абонементу</th>
                </tr>
                {% for student in group_detail.students %}
                <tr>
                    <td class="info-fio"><input type="checkbox" value="{{ student.person.id }}" /></td>
                    <td>{{ student.person.last_name }}</td>
                    <td>{{ student.person.first_name }}</td>
                    <td>+{{ student.person.phone }}</td>
                    <td>{{ student.person.e_mail }}</td>
                    <td>{% if student.person.org %}ОРГ{% endif %}</td>
                    <td>0</td>
                </tr>
                {% endfor %}
            </table>
            <a id="editStudentBtn" role="button" class="btn" data-toggle="modal">Добавить</a>
            <a id="deleteStudentBtn" role="button" class="btn disabled">Удалить</a>
        </div>
    </div>



    <!-- Форма "Карточка ученика" -->
    <div id="editStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Карточка ученика</h3>
        </div>
        <form class="form-horizontal" action="/group/editStudent">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="last_name">Фамилия</label>
                        <div class="controls">
                            <input type="text" name="last_name" id="last_name" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="first_name">Имя</label>
                        <div class="controls">
                            <input type="text" name="first_name" id="first_name" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="phone">Тел.</label>
                        <div class="controls">
                            <input type="tel" name="phone" id="phone" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="e_mail">E-mail</label>
                        <div class="controls">
                            <input type="email" name="e_mail" id="e_mail" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="is_org">ОРГ</label>
                        <div class="controls">
                            <input type="checkbox" name="is_org" id="is_org" />
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить" />
            </div>
        </form>
    </div>


    <!-- Форма редактирования занятия -->
    <div id="lesson_window" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4><span id="lesson_window_date"></span> - {{ group_detail.name }}</h4>
        </div>
        <div>
            <table id="lesson_content" class="table table-bordered table-striped"></table>
        </div>
        <div class="modal-footer">
            <button class="btn" style="float: left">Печать</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
            <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Сохранить</button>
        </div>
    </div>

    <!-- Форма выбора абонемента -->
    <div id="pass_menu" class="modal hide">
        <div>
            {% for p in pass_detail %}
                <div class="control-group">
                    <label class="radio">
                        <input type="radio" name="select_pass_type" value="{{ p.id }}">
                        {{ p.name }}
                    </label>
                </div>
            {% endfor %}
            <div class="control-group">
                <label class="radio">
                    <input id="not_self_pay" type="radio" name="select_pass_type" value="-1">
                    Списать с другого абонемента
                </label>
                <div id="pass_menu_advanced" style="display: none">
                    <input id="pass_menu_fio" type="text" placeholder="Фамилия Имя">
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">

        (function() {

            var matrix = new window.View.Matrix();

            /**
             * Получить дату из колонки
             * @param element
             * @returns {*}
             */
            function getDateFromColumn(element) {
                return matrix.getColumn(element)[0].text();
            }

            /**
             * Заполнить попап урока
             * @param context
             */
            function fillLessonsForm(context) {
                var $this = $('#lesson_window'),
                    $date = $('#lesson_window_date'),
                    names = matrix.getColumn(0),
                    lesson = matrix.getColumn(context),
                    container = $('#lesson_content'),
                    popoverLogic = new window.vidgetsLogic.Popover();

                container.empty();
                $date.text(getDateFromColumn(context));
                container.append('<tr><th>Фамилия Имя</th><th>Присутствие</th></tr>');

                for(var i= 1, j= names.length; i<j; i++) {
                    var tr = $('<tr>'),
                        name = $('<td>').append(names[i].html()),
                        state = $('<td>&nbsp;</td>');

                    state.attr('class', lesson[i].attr('class'));

                    // Удаляем следы hover-эффекта от родительской таблицы
                    state.removeClass('active');
                    state.removeClass('highlight');

                    // В зависимости от наличия абонемента подставляется разный контент
                    if(lesson[i].data('pass') === 'True') {
                        state.append(
                            $('<input type="checkbox" style="margin: 0" />')
                        );

                        state.click(function(event) {
                            var $target = $(event.target);

                            if(!$target.is('input')) {
                                var cb = $(this).children().first();

                                if(cb.prop('checked')) {
                                    cb.removeAttr('checked');
                                } else {
                                    cb.prop('checked', 'checked');
                                }
                            }
                        });

                    } else {

                        state.addClass('add-pass');

                        popoverLogic.init(state);

                        state.click(function() {
                            popoverLogic.hide();
                            popoverLogic.show($(this));
                        });

                    }

                    tr.append(name);
                    tr.append(state);

                    tr.appendTo(container);
                }
            }

            // Add DOM events
            var cl = $('.hover-able');

            cl.mouseenter(function(event) {

                var $this = $(this);

                if($this.hasClass('fio_cell')) {
                    if(!$this.hasClass('active')) $this.addClass('highlight');
                } else {
                    if(!$this.hasClass('active')) matrix.highlightColumn($this);
                }

            });

            cl.mouseleave(function() {

                var $this = $(this);

                if($this.hasClass('fio_cell')) {
                    if(!$(this).hasClass('active')) $this.removeClass('highlight');
                } else {
                    if(!$(this).hasClass('active')) matrix.unHighlightColumn($(this));
                }

            });

            var tr = $('#journal tr');

            tr.click(function(event) {

                var $this = $(event.target);

                if($this.hasClass('hover-able')) {

                    matrix.deactivateAll();

                    if(!$this.hasClass('fio_cell')) {
                        matrix.deactivateAll();
                        matrix.makeActive(event.target);
                    } else {
                        $this.addClass('highlight');
                        $this.addClass('active');
                    }

                }
            });

            tr.dblclick(function(event) {
                var $this = $(event.target),
                    date = getDateFromColumn($this);

                if($this.hasClass('hover-able')) {

                    fillLessonsForm($this);

                    if (!$this.hasClass('fio_cell')) {
                        $('#lesson_window').modal('show');
                    }
                }

            });

            /**
             * Заполнение таблицы редактирования
             * @type {*|jQuery|HTMLElement}
             */

            var $infoTable = $('#info table'),
                $studentForm = $('#editStudent'),
                addUrl = '/group/addstudent',
                editUrl = '/group/editstudent';

            $infoTable.find('tr').dblclick(function(event) {
                var $target = $(event.target);

                if(!$target.is('input') && !$target.is('.info-fio') && !$target.is('th')) {
                    var $this = $(this),
                    $children = $this.children();

                    $('#last_name').val($($children[1]).text());
                    $('#first_name').val($($children[2]).text());
                    $('#phone').val($($children[3]).text());
                    $('#e_mail').val($($children[4]).text());
                    $('#is_org').prop('checked', $($children[5]).text() == 'ОРГ' ? 'checked' : false);

                    $studentForm.find('form').attr('action', editUrl);
                    $studentForm.find('.btn.btn-primary').val('Сохранить');
                    $studentForm.modal('show');
                }
            });

            $('#editStudentBtn').click(function() {

                $('#last_name').val('');
                $('#first_name').val('');
                $('#phone').val('');
                $('#e_mail').val('');
                $('#is_org').prop('checked', false);

                $studentForm.find('form').attr('action', addUrl);
                $studentForm.find('.btn.btn-primary').val('Добавить');
                $studentForm.modal('show');
            });

            /**
             * checkbox
             */
            var $inputs = $('.info-fio input'),
                checkAllValue = -1;

            $inputs.click(function() {
                var $this = $(this),
                    $val = $this.val();

                if($val == checkAllValue) {

                    if($this.prop('checked')) {
                        $inputs.each(function() {
                            $(this).prop('checked', 'checked');
                            $('#deleteStudentBtn').removeClass('disabled');
                        });
                    } else {
                        $inputs.each(function() {
                            $(this).prop('checked', false);
                        });
                    }
                } else {
                    var $checked = $inputs.filter(':checked'),
                        $target = $inputs.filter('[value='+checkAllValue+']');
                    if($checked.length == $inputs.length-1 && !($target.prop('checked'))) {
                        $target.prop('checked','checked')
                    } else {
                        $target.prop('checked',false)
                    }
                }

                if($inputs.filter(':checked').length > 0) {
                    $('#deleteStudentBtn').removeClass('disabled');
                } else {
                    $('#deleteStudentBtn').addClass('disabled');
                }
            });

            $('#journalNav').click(function() {
                $('#infoLastLesson').show();
                $('#infoStartDate').hide();
            });

            $('#infoNav').click(function() {
                $('#infoLastLesson').hide();
                $('#infoStartDate').show();
            });

            // todo вынести все независимые блоки в свои области видимости
        })();
    </script>

{% endblock %}