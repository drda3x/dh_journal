{% extends "base.html" %}
{% block head %}
    <style>
        table td, table th {
            cursor: pointer;
        }
        .form-horizontal{
            margin: 0;
        }
        .modal-backdrop{
            background-color: inherit;
            opacity: 1;
        }
        #pass_form_html_body {
            padding: 15px 0 0 0;
        }
        .hover {
            position: relative;
        }
        .hover:after {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            content: "";
        }
    {% for color_class in passes_color_classes %}
        .{{ color_class.name }} {
            background-color: {{ color_class.val }};
        }
    {% endfor %}
    </style>
{% endblock %}
{% block body %}
    {{ group_detail.name }}
    <br>
    {{ group_detail.start_date }}
    <table class="table table-bordered">
        <tr>
            <th>
                Фамилия Имя
            </th>
            {% for date in group_detail.calendar %}
                <th>{{ date }}</th>
            {% endfor %}
        </tr>
        {% for student in group_detail.students %}
            <tr  data-stid="{{ student.person.id }}" class="student_row">
            <td class="student_cell">{{ student.person.first_name }} {{ student.person.last_name }}</td>
            {% for date in student.calendar %}
                <td class="student_cell {{ date.color }}" data-date="{{ date.date }}" data-pass="{{ date.pass }}">
                {% if date.pass %}
                    <strong>{{ date.sign }}</strong>
                {% else %}
                    {{ date.sign }}
                {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
    </table>

    <a href="#addStudent" role="button" class="btn" data-toggle="modal">Добавить ученика</a>

    <div id="addStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить ученика в группу</h3>
        </div>
        <form class="form-horizontal" action="/group/addstudent">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="last_name">Фамилия</label>
                        <div class="controls">
                            <input type="text" name="last_name" id="last_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="first_name">Имя</label>
                        <div class="controls">
                            <input type="text" name="first_name" id="first_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="phone">Тел.</label>
                        <div class="controls">
                            <input type="tel" name="phone" id="phone" value="+712345678"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="e_mail">E-mail</label>
                        <div class="controls">
                            <input type="email" name="e_mail" id="e_mail" value="t@e.st">
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить">
            </div>
        </form>
    </div>

    <div id="pass_form_html" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить абонемент</h3>
        </div>
        <form class="form-horizontal" action="/group/addpass" id="add_pass">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_start_date" id="pass_start_date" />
            <input type="hidden" name="student_id" id="student_id" />
            <input type="hidden" name="pass_group" value="{{ group_detail.id }}" />
            <div id="pass_form_html_body" class="modal-body">
                 <div class="control-group">
                     <label class="control-label" for="student_name">Ученик</label>
                     <div class="controls">
                         <input id="student_name" type="text" disabled value="">
                     </div>
                 </div>
                <div class="control-group">
                    <label class="control-label" for="date_start">Действует с</label>
                    <div class="controls">
                         <input id="date_start" type="text" disabled value="">
                     </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="pass_type">Тип абонемента</label>
                    <div class="controls">
                        <select id="pass_type" name="pass_type">
                            {% for p in pass_detail %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                    <input type="submit" class="btn btn-primary" value="Добавить абонемент" id="pass_submit">
                </div>
            </div>
        </form>
    </div>

    <div id="single_pass_form" style="display: none">
        <form action="/group/addpass" id="add_single_pass">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_start_date" id="pass_start_date" />
            <input type="hidden" name="student_id" id="student_id" />
            <input type="hidden" name="pass_group" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_type" value="{{ single_pass_id.id }}">
            <input type="submit" class="btn" value="Разовое занятие" id="single_pass_submit">
        </form>
    </div>

    <script type="text/javascript">
        (function() {

            var cl = $('.student_cell');

            cl.mouseenter(function() {
                if(!$(this).hasClass('active')) $(this).addClass('hover');
            });

            cl.mouseleave(function() {
                if(!$(this).hasClass('active')) $(this).removeClass('hover');
            });

            var prev_popover;

            function cleanScreen() {

                try {
                    prev_popover.popover('destroy');
                    prev_popover.remove();
                } catch(e) {
                }

                cl.removeClass('hover');
            }

            function getPopoverContent(elem) {
                var hasPass = elem.data('pass') ? elem.data('pass') : 'False',
                    contents = {
                        True: $('<button class="btn">Отметить присутствие</button>'),
                        False: $($('#single_pass_form').html()+'<a href="#pass_form_html" role="button" class="btn add-pass" data-toggle="modal">Абонемент</a>')
                    };

                return contents[hasPass]
            }

            cl.click(function(event) {

                cleanScreen();

                var target = $(event.target),
                    self = $(this);

                if(target.hasClass('add-pass')) {

                    var name = (function() {
                        var parent = $(self.parent()),
                            first_sb = $(parent.children()[0]);

                        return first_sb.text()
                    })();

                    var date = self.data('date'),
                        studentId = $(self.parent()).data('stid');

                    $('#student_id').val(studentId);
                    $('#student_name').val(name);
                    $('#date_start').val(date);
                    $('#pass_start_date').val(date);

                } else {
                    if(!$(this).hasClass('active')) {
                        cl.removeClass('active');
                        $(this).addClass('active');
                        $(this).addClass('hover');

                        var pos = self.position(),
                            dim = {
                                width: self.width(),
                                height: self.height()
                            },
                            div = $('<div style="position: absolute; bottom: 0; left:'+ dim.width/2 +'px"></div>');

                        self.append(div);
                        div.popover({placement: 'bottom', content: ' ', animation: false});

                        div.popover('show');
                        $('.popover-content').html(getPopoverContent(self));

                        prev_popover = div;
                    } else {
                        cl.removeClass('active');
                    }
                }
            });

        })();
    </script>

{% endblock %}