{% extends "base.html" %}
{% block head %}
    <style>
        table td, table th {
            cursor: pointer;
        }
        .form-horizontal{
            margin: 0;
        }
        .modal-backdrop{
            background-color: inherit;
            opacity: 1;
        }
        .hover {
            position: relative;
        }
        .hover:after {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            content: "";
        }
    {% for color_class in passes_color_classes %}
        .{{ color_class.name }} {
            background-color: {{ color_class.val }};
        }
    {% endfor %}
    </style>
{% endblock %}
{% block body %}
    {{ group_detail.name }}
    <br>
    {{ group_detail.start_date }}
    <table class="table table-bordered">
        <tr>
            <th>
                Фамилия Имя
            </th>
            {% for date in group_detail.calendar %}
                <th>{{ date }}</th>
            {% endfor %}
        </tr>
        {% for student in group_detail.students %}
            <tr  data-stid="{{ student.person.id }}" class="student_row">
            <td class="student_cell">{{ student.person.first_name }} {{ student.person.last_name }}</td>
            {% for date in student.calendar %}
                <td class="student_cell {{ date.color }}" data-date="{{ date.date }}" data-pass="{{ date.pass }}">
                {% if date.pass %}
                    <strong>{{ date.sign }}</strong>
                {% else %}
                    {{ date.sign }}
                {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
    </table>

    <a href="#addStudent" role="button" class="btn" data-toggle="modal">Добавить ученика</a>

    <div id="addStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить ученика в группу</h3>
        </div>
        <form class="form-horizontal" action="/group/addstudent">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="last_name">Фамилия</label>
                        <div class="controls">
                            <input type="text" name="last_name" id="last_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="first_name">Имя</label>
                        <div class="controls">
                            <input type="text" name="first_name" id="first_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="phone">Тел.</label>
                        <div class="controls">
                            <input type="tel" name="phone" id="phone" value="+712345678"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="e_mail">E-mail</label>
                        <div class="controls">
                            <input type="email" name="e_mail" id="e_mail" value="t@e.st">
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить">
            </div>
        </form>
    </div>


    <form class="form-horizontal" action="/group/addpass" id="add_pass">
        <input type="hidden" name="pass_start_date" id="pass_start_date" />
        <input type="hidden" name="student_id" id="student_id" />
        <input type="hidden" name="pass_group" value="{{ group_detail.id }}" />
        <div class="control-group">
            <label class="control-label" for="pass_type">Тип абонемента</label>
            <div class="controls">
                <select id="pass_type" name="pass_type">
                    {% for p in pass_detail %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="control-group">
            <div class="controls">
                <input type="submit" class="btn" value="Добавить абонемент" id="pass_submit">
            </div>
        </div>
    </form>

    <script type="text/javascript">
        (function() {

            var target, studentName, studentId, date;

            $('.student_row').click(function(event) {
                target = $(event.target);
                studentId = $(this).data('stid');
                studentName = $($(this).children()[0]).text();
                date = target.data('date');
                $('#student_id').val(studentId);
              $('#pass_start_date').val(date)
            });

            var cl = $('.student_cell');

            cl.mouseenter(function() {
                $(this).addClass('hover');
            });

            cl.mouseleave(function() {
                $(this).removeClass('hover');
            });

            var prev_popover;

            cl.click(function(event) {

                try {
                    prev_popover.popover('destroy');
                } catch (e) {}

                target = $(event.target);

                if(!target.is('td')) {
                    var parents = target.parentsUntil('tr').reverse();
                    target = $(parents.pop());
                }

                popover_target = $(target.children()[0]);

                popover_target.popover({placement: 'bottom', content:'right'});
                popover_target.popover('show');

                prev_popover = popover_target;
            });

        })();
    </script>

{% endblock %}