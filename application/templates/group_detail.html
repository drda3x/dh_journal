{% extends "base.html" %}

{% block head %}

    <style>

        .table {
            border-color: #000000;
        }

        .table td, .table th {
            cursor: pointer;
            border-color: #000000;
        }

        .table td {
            line-height: 10px;
        }

        .form-horizontal{
            margin: 0;
        }

        .modal-backdrop{
            background-color: inherit;
            opacity: 1;
        }

        #pass_form_html_body {
            padding: 15px 0 0 0;
        }

        .highlight {
            position: relative;
        }

        .highlight:after {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            content: "";
        }

    {% for color_class in passes_color_classes %}

        .{{ color_class.name }} {
            background-color: {{ color_class.val }};
        }

    {% endfor %}

    </style>

{% endblock %}

{% block body %}

    {{ group_detail.name }}
    <br>
    {{ group_detail.start_date }}

    <table class="table table-bordered">
        <tr>
            <th>
                Фамилия Имя
            </th>
            {% for date in group_detail.calendar %}
                <th class="hover-able">{{ date }}</th>
            {% endfor %}
        </tr>
        {% for student in group_detail.students %}
            <tr  data-stid="{{ student.person.id }}" class="student_row">
            <td class="hover-able student_cell">{{ student.person.first_name }} {{ student.person.last_name }}</td>
            {% for date in student.calendar %}
                <td class="hover-able student_cell {{ date.color }}" data-date="{{ date.date }}" data-pass="{{ date.pass }}">
                {% if date.pass %}
                    <strong>{{ date.sign }}</strong>
                {% else %}
                    {{ date.sign }}
                {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
    </table>

    <a href="#addStudent" role="button" class="btn" data-toggle="modal">Добавить ученика</a>

    <div id="addStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить ученика в группу</h3>
        </div>
        <form class="form-horizontal" action="/group/addstudent">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="last_name">Фамилия</label>
                        <div class="controls">
                            <input type="text" name="last_name" id="last_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="first_name">Имя</label>
                        <div class="controls">
                            <input type="text" name="first_name" id="first_name" value="test" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="phone">Тел.</label>
                        <div class="controls">
                            <input type="tel" name="phone" id="phone" value="+712345678"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="e_mail">E-mail</label>
                        <div class="controls">
                            <input type="email" name="e_mail" id="e_mail" value="t@e.st">
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить">
            </div>
        </form>
    </div>

    <div id="pass_form_html" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Добавить абонемент</h3>
        </div>
        <form class="form-horizontal" action="/group/addpass" id="add_pass">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_start_date" id="pass_start_date" />
            <input type="hidden" name="student_id" id="student_id" />
            <input type="hidden" name="pass_group" value="{{ group_detail.id }}" />
            <div id="pass_form_html_body" class="modal-body">
                 <div class="control-group">
                     <label class="control-label" for="student_name">Ученик</label>
                     <div class="controls">
                         <input id="student_name" type="text" disabled value="">
                     </div>
                 </div>
                <div class="control-group">
                    <label class="control-label" for="date_start">Действует с</label>
                    <div class="controls">
                         <input id="date_start" type="text" disabled value="">
                     </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="pass_type">Тип абонемента</label>
                    <div class="controls">
                        <select id="pass_type" name="pass_type">
                            {% for p in pass_detail %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                    <input type="submit" class="btn btn-primary" value="Добавить абонемент" id="pass_submit">
                </div>
            </div>
        </form>
    </div>

    <div id="single_pass_form" style="display: none">
        <form action="/group/addpass" id="add_single_pass">
            <input type="hidden" name="id" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_start_date" id="pass_start_date" />
            <input type="hidden" name="student_id" id="student_id" />
            <input type="hidden" name="pass_group" value="{{ group_detail.id }}" />
            <input type="hidden" name="pass_type" value="{{ single_pass_id.id }}">
            <input type="submit" class="btn" value="Разовое занятие" id="single_pass_submit">
        </form>
    </div>

    <script type="text/javascript">
        (function() {

            /**
             * Класс 'Матрица'
             */
            function Matrix() {
                this.current_column_num = null;
                this.content = [];

                var rows = $('.table tbody').children();

                for(var i= 0, j=rows.length; i<j; i++) {
                    var row=rows[i],
                            cells = $(row).children();

                    for(var k= 0, m= cells.length; k<m; k++) {
                        if (i == 0) this.content[k] = [];
                        var cell = $(cells[k]);

                        cell.column_index = k;
                        cell.attr('data-column', k);

                        this.content[k].push(cell);
                    }
                }
            }

            /**
             * Получить всю колонку в которую входит переданный элемент
             * @param element
             * @returns {*}
             */
            Matrix.prototype.getColumn = function(element) {
                var $element = $(element),
                    column_num = $element.data('column');

                return this.content[column_num];
            };

            /**
             * Добавить класс для колонки
             * @param element
             * @param cl
             */
            Matrix.prototype.addClassToColumn = function(element, cl) {

                var column = this.getColumn(element);

                for(var i= 0, j= column.length; i<j; i++) {
                    column[i].addClass(cl);
                }
            };

            /**
             * Удалить класс для колонки
             * @param element
             * @param cl
             */
            Matrix.prototype.removeClassFromColumn = function(element, cl) {
                var column = this.getColumn(element);

                for(var i= 0, j= column.length; i<j; i++) {
                    column[i].removeClass(cl);
                }
            };

            /**
             * Подсветить колонку
             * @param element
             */
            Matrix.prototype.highlightColumn = function(element) {
                this.addClassToColumn(element, 'highlight')
            };

            /**
             * Убрать подсветку колонки
             * @param element
             */
            Matrix.prototype.unHighlightColumn = function(element) {
                this.removeClassFromColumn(element, 'highlight')
            };

            /**
             * Сделать колонку активной
             * @param element
             */
            Matrix.prototype.makeActive = function(element) {
                this.highlightColumn(element);
                this.addClassToColumn(element, 'active')
            };

            /**
             * Сделать все колонки не активными
             */
            Matrix.prototype.deactivateAll = function() {
                for(var i= this.content.length - 1; i >= 0; i--) {

                    var elem = this.content[i][0];

                    this.unHighlightColumn(elem);
                    this.removeClassFromColumn(elem, 'active')
                }
            };

            var matrix = new Matrix();


            // Add DOM events
            var cl = $('.hover-able');
            cl.mouseenter(function() {
                if(!$(this).hasClass('active')) matrix.highlightColumn($(this));
            });

            cl.mouseleave(function() {
                if(!$(this).hasClass('active')) matrix.unHighlightColumn($(this));
            });

            $('.table tr').click(function(event) {

                matrix.deactivateAll();
                matrix.makeActive(event.target);

            });

        })();
    </script>

{% endblock %}