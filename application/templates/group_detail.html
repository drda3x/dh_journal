{% extends "base.html" %}
{% load staticfiles %}
{% load i18n %}
{% block style%}
    <link rel="stylesheet" href="{% static "css/group_detail.css" %}">
    <style>
        .profitgood {
         background-color: #33ff99 !important;
         }
         .profitbad {
         background-color: #fc4e3a !important;
         }
         .profitnormal {
         background-color: #9aceeb !important;
         }

         .textstrong {
             font-weight: bold;
         }

         .nomargin {
             margin-left: 0 !important;
         }
         .checkb {
             padding: 5px 15px !important;
         }

         .daypopup-teachers {
            background-color: #fff;
            border-radius: 5px;
            padding: 10px 15px 2px;
            margin-bottom: 10px;
            border: 1px solid rgb(227, 227, 227);
            text-align: center;
         }

         .daypopup-teachers table {
             background-color: inherit !important;
         }
         .modal-backdrop {
            opacity: 0.9;
         }
         .modal {
             border: 1px solid rgb(227, 227, 227) !important;
         }
         .modal-header {
            background-color: #f5f5f5;
            border-radius: 7px 7px 0 0;
         }
         .modal-body {
            background-color: #f5f5f5;
         }

         {% for typ in passes_color_classes%}
             .{{typ.name}} { background-color: {{typ.val}}; }
         {% endfor %}

    </style>

    <script type="text/javascript" src="{% static "js/matrix.js" %}"></script>
    <script type="text/javascript" src="{% static "js/popover.js" %}"></script>

    <script type="text/javascript" src="{% static "js/group_detail.js" %}"></script>
    <script type="text/javascript">
        window.pageInit(
            {{group_detail | safe}}, 
            {{control_data | safe}},
            {{pass_detail | safe}},
            {{substitutions | safe}},
            {{teachers | safe}}
        )
    </script>
{% endblock %}
{% block script %}
{% endblock %}
{% block content %}
            {% verbatim %}
            <div ng-class="{span10: toggleSideBar_local, span12: !toggleSideBar_local, nomargin: !toggleSideBar_local}" class="well" ng-controller="GroupCtrl">
            <div>
                <a class="toggle-button" 
                    style="float:left; padding-right: 4px;" 
                    href="" 
                    ng-show="!toggleSideBar_local"
                    ng-click="setSideBarStatus(true)">
                        <div class="carret-left" style="margin-left: 14px"></div>
                </a>
            </div>
            <div class="row-fulid" ng-class="{slided: !toggleSideBar_local}">
            <div class="span4" style="margin-top: -13px">
                <div class="btn-group" ng-class="{slided: toggleSideBar_local}">
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        {{control_data.constant.current_date_str}}
                    <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li ng-repeat="dt in control_data.date_control"><a href="http://{%endverbatim%}{{host}}/group/{%verbatim%}{{dt.val}}">{{dt.name}}</a></li>
                    </ul>
                </div>
                <button class="btn" ng-click="addStudentFromMain()">Добавить</button>
                <button class="btn" ng-show="row != null" ng-click="deleteStudent()">Удалить</button>
                <!--
                <button class="btn btn-primary">Перенести занятия</button>
                <button class="btn btn-primary">Перевести в другую группу</button>
                -->
            </div>
            <h4 class="group-title span8" style="margin-top: -10px">
                {{data.group_data.dance_hall.station}} {{data.group_data.days}} {{data.group_data.time}}({{data.group_data.name}}) {{data.group_data.teachers_repr}}
            </h4>
        </div>
        <div class="row-fulid">
            <div ng-class="{span4: column!=null}" >
                <table class="table table-bordered region" ng-mouseleave="columnIndexCache(null); rowIndexCache(null)">
                    <tr>
                        <th>Фамилия Имя</th>
                        <th ng-show="!toggleSideBar_local">Телефон</th>
                        <th ng-show="!toggleSideBar_local">Коментарий</th>
                        <th ng-repeat="date_rec in data.calendar" ng-click="columnClick($index)" ng-show="column == null || column==$index" ng-class="getProfit(date_rec.profit)">{{date_rec.date}}<br><span ng-show="date_rec.canceled" class="text-error">ОТМЕНЕНО</span></th>
                    </tr>
                    <tr ng-show="(row==null && (checkActive(student) || column != null)) || $index==row" ng-repeat="student in data.students" ng-mouseover="rowIndexCache($index)" ng-show="row == null || row == $index" ng-init="rowIndex=$index">
                        <td ng-click="rowClick($index, student)" 
                            ng-mouseover="columnIndexCache(null);" 
                            ng-class="{highlight: hoveredRow==rowIndex}">
                            {{student.person.last_name}} {{student.person.first_name}}
                            <div class="phone">{{student.person.phone}}</div>
                        </td>
                        <td ng-show="!toggleSideBar_local"
                            ng-click="rowClick($index, student)" 
                            ng-mouseover="columnIndexCache(null);" 
                            ng-class="{highlight: hoveredRow==rowIndex}"
                            class="span4">{{trimComment((student.comments|last).text, 35)}}</td>
                        <td ng-class="{highlight: column==null && (hoveredColumn==$index || hoveredRow==rowIndex)}" 
                            ng-mouseover="columnIndexCache($index)" 
                            ng-click="columnClick($index)" 
                            class="{{lesson.color}}" 
                            ng-repeat="lesson in student.calendar track by $index">
                            <strong ng-show="column == null" ng-class="{redsign: !checkSign(lesson.sign)}">{{lesson.sign | makePositive}}</strong>
                            <strong ng-show="column!=null && lesson.debt && !lesson.pass">({{lesson.sign | makePositive}})</strong>
                        </td>
                    </tr>
                    <tr ng-mouseover="rowIndexCache(null)" ng-show="row==null && column==null" >
                        <td ng-show="toggleSideBar_local" ng-mouseover="columnIndexCache(null)" style="border-top: 3px solid"><strong>Всего за день</strong></td>
                        <td colspan="2" ng-show="!toggleSideBar_local" ng-mouseover="columnIndexCache(null)" style="border-top: 3px solid"><strong>Всего за день</strong></td>
                        <td ng-class="{highlight: !column && hoveredColumn==$index}" 
                            style="border-top: 3px solid" 
                            ng-repeat="money_rec in data.moneys"
                            ng-click="columnClick($index)"
                            ng-show="column == null || column==$index">{{money_rec.day_total}}</td>
                    </tr>
                    <tr ng-mouseover="rowIndexCache(null)" ng-show="row==null && column==null">
                        <td ng-show="toggleSideBar_local" ng-mouseover="columnIndexCache(null)"><strong>Аренда зала</strong></td>
                        <td colspan="2" ng-show="!toggleSideBar_local" ng-mouseover="columnIndexCache(null)"><strong>Аренда зала</strong></td>
                        <td ng-mouseover="columnIndexCache($index)" 
                            ng-repeat="money_rec in data.moneys" 
                            ng-class="{highlight: !column && hoveredColumn==$index}"
                            ng-click="columnClick($index)"
                            ng-show="column == null || column==$index">{{money_rec.dance_hall}}</td>
                    </tr>
                    <tr ng-mouseover="rowIndexCache(null)" ng-show="row==null && column==null">
                        <td ng-show="toggleSideBar_local" ng-mouseover="columnIndexCache(null)"><strong>% клуба</strong></td>
                        <td colspan="2" ng-show="!toggleSideBar_local" colspan="{{getColspan(null)}}" ng-mouseover="columnIndexCache(null)"><strong>% клуба</strong></td>
                        <td ng-mouseover="columnIndexCache($index)"  
                            ng-repeat="money_rec in data.moneys" 
                            ng-class="{highlight: !column && hoveredColumn==$index}"
                            ng-click="columnClick($index)"
                            ng-show="column == null || column==$index">{{money_rec.club}}</td>
                    </tr>
                    <tr ng-mouseover="rowIndexCache(null)" ng-show="row==null && column==null">
                        <td ng-show="toggleSideBar_local" ng-mouseover="columnIndexCache(null)"><strong>Итого</strong></td>
                        <td colspan="2" ng-show="!toggleSideBar_local" colspan="{{getColspan(null)}}" ng-mouseover="columnIndexCache(null)"><strong>Итого</strong></td>
                        <td ng-mouseover="columnIndexCache($index)"  
                            ng-repeat="money_rec in data.moneys" 
                            ng-class="{highlight: !column && hoveredColumn==$index}"
                            ng-click="columnClick($index)"
                            ng-show="column == null || column==$index">{{money_rec.balance}}</td>
                    </tr>
                    <tr ng-repeat="sal in salary" ng-show="row==null && column==null">
                        <td class="textstrong" ng-show="toggleSideBar">{{sal[0]}}</td>
                        <td class="textstrong" ng-hide="toggleSideBar" colspan="2">{{sal[0]}}</td>
                        <td ng-mouseover="columnIndexCache($index)" 
                            ng-repeat="val in sal | slice:1 track by $index" 
                            ng-class="[{highlight: !column && hoveredColumn==$index}]"
                            ng-click="columnClick($index)"
                            ng-show="column == null || column==$index">{{val}}</td>
                    </tr>
                </table>
            </div>
            <div class="span6" ng-show="column!=null">
                <div class="row-fulid">
                    <div class="span6">
                     <h4>Преподаватели</h4>
                     <table class="region table table-bordered">
                         <tr ng-repeat="day_subst in substitutions" ng-show="$index == column" >
                             <td ng-repeat="cur_teacher in day_subst" ng-init="teacherIndex = $index" style="border-top: none">
                                 <select ng-model="day_subst[teacherIndex]">
                                     <option ng-repeat="teacher in teachers" 
                                             ng-value="teacher.id">
                                            {{teacher.last_name}} {{teacher.first_name}}
                                     </option>
                                 </select>
                             </td>
                         </tr>
                     </table>
                  </div>
                </div>
                <div class="row-fulid day-buttons">
                  <div class="span7">
                  <button class="btn btn-danger" ng-click="cancelLesson()">Отменить занятие</button>
                  <button class="btn btn-primary" ng-click="columnClick(null)">Вернуться к ведомости</button>
                  </div>
                </div>
                <div class="row-fulid day-buttons">
                  <div class="span7">
                    <button class="btn btn-success" ng-click="saveLessons(true)">Сохранить и проставить пропуски</button>
                    <button class="btn btn-primary" ng-click="saveLessons(false)">Сохранить без пропусков</button>
                  </div>
                </div>
                <div class="row-fulid day-buttons">
                  <div class="span7">
                    <button class="btn btn-danger">Удалить все отметки</button>
                  </div>
                </div>
            </div>
        </div>
            <div class="row-fulid" ng-show="row!=null">
               <div class="span3">
                   <form action="">
                       <fieldset>
                            <legend>Редактирование</legend>
                           <input ng-model="selected_student.last_name" type="text" placeholder="Фамилия">
                           <input ng-model="selected_student.first_name" type="text" placeholder="Имя">
                           <input ng-model="selected_student.phone" type="text" placeholder="Телефон">
                           <label for="" class="checkbox">
                               ОРГ
                               <input ng-model="selectes_student.org" type="checkbox">
                           </label>
                       </fieldset>
                   </form>
                   
                  <button class="btn btn-primary" ng-click="saveStudent()">Сохранить</button>
                  <button class="btn btn-danger" ng-click="checkStudents(); rowClick(null)">Отмена</button>
               </div>
               <div class="span6 offset1">
                   <legend>Коментарии</legend>
                   <div ng-show="selected_student.comments.length > 0" class="region coment-main">
                       <div class="coment row-fulid" ng-repeat="comment in selected_student.comments"><div class="text-info" style="font-weight: bold;">{{comment.add_date}}</div>{{comment.text}}</div>
                   </div>
                   <textarea class="span12 coment-add" id="" name="" cols="50" rows="3" style="resize: none;" placeholder="Введите коментарий" ng-model="new_comment"></textarea>
                  <button class="btn btn-primary" ng-click="saveComment()">Сохранить</button>
                  <button class="btn btn-danger" ng-click="checkStudents(); rowClick(null)">Отмена</button>
               </div>
           </div>
        <div class="row"></div>
        <div class="row-fluid" ng-show="row==null && column==null">
           <div class="span2">
              <h4>Сбор за месяц</h4>
              <table class="region table table-bordered">
                 <tbody><tr>
                    <td>Всего</td>
                    <td>{{data.money_total.day_total}}</td>
                 </tr>
                 <tr>
                    <td>Аренда зала</td>
                    <td>{{data.money_total.dance_hall}}</td>
                 </tr>
                 <tr>
                    <td>% клуба</td>
                    <td>{{data.money_total.club}}</td>
                 </tr>
                 <tr>
                    <td>ИТОГО</td>
                    <td>{{data.money_total.balance}}</td>
                 </tr>
                 <tr>
                    <td>На следующий месяц</td>
                    <td ng-show="data.money_total.next_month_balance > 0">{{data.money_total.next_month_balance}}</td>
                    <td ng-hide="data.money_total.next_month_balance > 0">0</td>
                 </tr>
              </tbody></table>
           </div>
           <div class="span3">
              <h4>Зарплата</h4>
              <table class="region table table-bordered">
                  <tr ng-repeat="sal in month_sal">
                      <td>{{sal.teacher.last_name}} {{sal.teacher.first_name}}</td>
                      <td>{{sal.sal.count}} ({{sal.sal.compensation}})</td>
                  </tr>
              </table>
           </div>
           <div class="span7">
              <h4>Люди не посещающие занятия</h4>
              <table class="region table table-bordered table-hover">
                  <tr ng-repeat="student in data.students" 
                      ng-show="!checkActive(student)"
                      ng-click="rowClick($index, student)">
                      <td>
                          {{student.person.last_name}} {{student.person.first_name}}
                          <div class="phone">{{student.person.phone}}</div>
                      </td>
                      <td>
                          {{(student.comments|last).text}}
                      </td>
                  </tr>
              </table>
           </div>
        </div>
        
        <div class="modal" ng-hide="!paymentModal" style="z-index: 9999" >
            <div class="modal-header">
               {{paymentModal.student.person.last_name}} {{paymentModal.student.person.first_name}} 
            </div>
            <div class="modal-body">

                <form class="form-horizontal" ng-show="paymentModal.is_newbie">
                    <div class="controll-group">
                        <label class="control-label" for="paymentChoise">Фамилия:</label>
                        <div class="controls">
                            <input type="text" id="surname" ng-model="paymentModal.student.person.last_name">
                        </div>
                    </div>
                    <div class="controll-group">
                        <label class="control-label" for="lessons">Имя: </label>
                        <div class="controls">
                            <input type="text" id="lessons" ng-model="paymentModal.student.person.first_name">
                        </div>
                    </div>
                    <div class="controll-group">
                        <label class="control-label" for="skips">Телефон:</label>
                        <div class="controls">
                            <input type="text" id="skips" ng-model="paymentModal.student.person.phone">
                        </div>
                    </div>
                    <legend></legend>
                </form>

                <form class="form-horizontal">
                    <div class="controll-group">
                        <label class="control-label" for="paymentChoise">Тип абонемента:</label>
                        <div class="controls">
                            <select id="paymentChoise" id="paymentChoise" ng-model="selectedPass" ng-change="paymentChange(selectedPass)">
                                <option ng-show="paymentModal.club_card" ng-value="paymentModal.club_card">Списать занятие с клубной карты</option>
                                <option ng-repeat="pass in passes" ng-value="pass">{{pass.name}}</option>
                            </select>
                        </div>
                    </div>
                    <div class="controll-group">
                        <label class="control-label" for="lessons">Кол-во уроков: </label>
                        <div class="controls">
                            <input type="text" id="lessons" ng-model="selectedPass._lessons">
                        </div>
                    </div>
                    <div class="controll-group">
                        <label class="control-label" for="skips">Кол-во пропусков:</label>
                        <div class="controls">
                            <input type="text" id="skips" ng-model="selectedPass._skips">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" ng-click="savePayment(selectedPass); checkStudents(); resetModal()">Сохранить</button>
              <button class="btn" ng-click="checkStudents(); resetModal()">Отмена</button>
            </div>
        </div>

        <div class="modal" style="z-index: 9998" ng-show="showDayPopup">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" ng-click="destroyDayPopup(); checkStudents(); resetModal()">&times;</button>
            <h4>
                <span>01.07.2017</span>
            </h4>
                <button class="btn" ng-click="addStudentFromPopup(day_popup.day_index)" >Добавить ученика</button>
            </div>


          <div class="modal-body">
              <table class="table table-bordered region" ng-mouseleave="columnIndexCache(null); rowIndexCache(null)">
                  <tr>
                      <th>Фамилия, Имя</th>
                      <th>Оплата</th>
                  </tr>
                  <tr ng-repeat="row in day_popup.rows">
                      <td>{{row.student.person.last_name}} {{row.student.person.first_name}}</td>
                      <td class="{{row.day_data.color}}" ng-class="{checkb: row.day_data.pass}">
                            <a href="" ng-show="!row.day_data.pass" ng-click="processPayment(row.day_data, row.student, false, day_popup.day_index)">Добавить оплату</a>
                            <label for="" class="checkbox" ng-show="row.day_data.pass"  style="margin: 0;">
                                <input type="checkbox" 
                                    ng-show="row.day_data.pass" 
                                    ng-model="row.day_data.attended" ng-click="processPayment(row.day_data, student, false, day_popup.day_index)" />
                                    <strong ng-class="{redsign: !checkSign(row.day_data.sign)}">{{row.day_data.sign | makePositive}}</strong>
                                </label>
                          </td>
                      </tr>
                  </table>
            </div>
              <div class="modal-footer">
                <div class="daypopup-teachers">
                   <span ng-repeat="cur_teacher in day_popup.teachers">
                      <select ng-model="day_popup.teachers[$index]">
                            <option ng-repeat="teacher in teachers" 
                                    ng-value="teacher.id">
                                {{teacher.last_name}} {{teacher.first_name}}
                        </option>
                    </select>
               </span>
          </div>
            <a href="#" class="btn" ng-click="saveLessons(false, day_popup.day_index)">Сохранить без пропусков</a>
            <a href="#" class="btn btn-primary" ng-click="saveLessons(true, day_popup.day_index)">Сохранить c пропусками</a>
          </div>
        </div>

        <div class="modal-backdrop" ng-show="showDayPopup" ng-click="destroyDayPopup(); checkStudents(); resetModal()"></div>
    </div>


    {% endverbatim %}

{% endblock %}
