{% extends "base.html" %}
{% block head %}
    <link rel="stylesheet" href="../static/shortcard/short_card.css" />
    <style type="text/css">
        .center{
            text-align: center !important;
        }
    </style>
    <script type="text/javascript" src="../static/js/logic.js"></script>
	<script type="text/javascript" src="../static/js/modal_popover.js"></script>
	<script type="text/javascript" src="../static/shortcard/short_card.js"></script>
	<script type="text/javascript" src="../static/js/mk2.js"></script>
	<script>

	    window.onload = function() {
	        // add global params
	        if(!window.pageParams) window.pageParams = {};
	        window.pageParams.group_id = {{ group_id }};

	        // create Table instance
	        var table = new window.Table('table');

	        // create StudentCard
	        var studentCard = new window.StudentCard('#editStudent');

            // create ContextMenu
            var contextMenu = window.createShortcard().init();

            // save current model of table
            var tableContext = null;

            contextMenu.addElement('Изменить', function(event) {
                $('#editStudentBtn').trigger('click');

                for(var i in table.currentRow) {
                    if(studentCard.$data.hasOwnProperty(i)) {
                        studentCard.$data[i] = table.currentRow[i];
                    }
                }
            });

            contextMenu.addElement('Удалить', function() {
                console.log('delete')
            });

            contextMenu.addElement('Коментарий', function() {
                console.log('comment');
            });

	        $('#editStudentBtn').click(function() {
	        	studentCard.clear();
	        });

	        $('#deleteStudentBtn').click(function() {
	        	var to_delete = table.getSelectedRows('id');

	        	sendRequest({
		        		gid: window.pageParams.group_id,
		        		ids: JSON.stringify(to_delete)
		        	}, 
		        	'delete',
		        	function(err, data) {
		        		if(err) {
		        			console.log(err);
		        		} else {
		        			table.deleteRow(to_delete);
		        		}
		        	}
	        	)
	        });

	        $(document).on('table-row-click', function(event, data, model) {
	            tableContext = model;
	            contextMenu.show(data.pageX, data.pageY);
	        });

	    	$(document).on('submit', function() {
	    		var form = $(this).data('modalpopover').$tip,
	    			data = {};

                form.find('select').each(function() {
                    var fieldName = $(this).attr('name');
                    data[fieldName] = $(this).val();
                    data[fieldName + '_str'] = $(this).find('option[value='+data[fieldName]+']').text();
                });

	    		$(this).trigger('add-form-submit', data)
	    	});

	    	$(document).click(function() {
	    	    tableContext = null;
	    	    contextMenu.hide();
	    	})
	    }
    </script>
{% endblock %}
{% block body %}
	<a id="editStudentBtn" href="#editStudent" role="button" class="btn" data-toggle="modal">Добавить</a>
	<a id="deleteStudentBtn" href="#deleteStudent" role="button" class="btn" data-toggle="modal">Удалить</a>
	<table class="table table-bordered table-striped table-hover">
	<tr class="shotcard-disabled" data-index="0">
	    <th data-name="id"><input class="row-selector" type="checkbox" value="-1" /></th>
	    <th data-name="cnt">№</th>
	    <th data-name="last_name" style="min-width: 100px;">Фамилия</th>
	    <th data-name="first_name" style="min-width: 100px;">Имя</th>
	    <th data-name="phone" style="min-width: 133px;">Телефон</th>
	    <th data-name="e_mail" style="min-width: 150px;">E-mail</th>
	    <th data-name="id">Присутствие</th>
	    <th data-name="pass">Приобретенный абонемент</th>
	    <th data-name="comment" style="min-width: 120px;">Коментарий</th>
	</tr>
	{% for record in students %}
	<tr data-index="{{ forloop.counter }}">
	    <td><input class="row-selector" type="checkbox" value="{{ record.student.id }}" /></td>
	    <td>{{ forloop.counter }}</td>
	    <td>{{ record.student.last_name }}</td>
	    <td>{{ record.student.first_name }}</td>
	    <td>{{ record.student.str_phone }}</td>
	    <td>{% if record.student.e_mail %}{{ record.student.e_mail }}{% endif %}</td>
	    <td class="center"><input class="attendance" type="checkbox" value="{{ record.student.id }}" {% if record.attendance %}checked="checked"{% endif %} /></td>
	    <td class="center">
            {% if record.group %}
                {{ record.group.simple_repr }}(<a class="del" href="#">удалить</a>)
            {% else %}
			    <a data-class="add" class="add" href="#">Добавить</a>
            {% endif %}
		</td>
		<td></td>
    </tr>
	{% endfor %}
<!-- {# 	{% for student in group_detail.students %}
	<tr data-id="{{ student.person.id }}" data-active="{{ student.person.active }}">
	    <td class="info-fio shotcard-disabled"><input class="shotcard-disabled" type="checkbox" value="{{ student.person.id }}" /></td>
	    <td>{{ forloop.counter }}</td>
	    <td style="min-width: 100px;">{{ student.person.last_name }}</td>
	    <td style="min-width: 100px;">{{ student.person.first_name }}</td>
	    <td style="min-width: 133px;">{{ student.person.str_phone }}</td>
	    <td style="min-width: 150px;">{{ student.person.e_mail }}</td>
	    <td>{% if student.person.org %}ОРГ{% endif %}</td>
	    <td>{{ student.pass_remaining }}
	        {% if student.debt %}
	            <strong class="text-error">ДОЛГ ({{ student.debt }})</strong>
	        {% endif %}
	    </td>
	    <td class="comment" style="min-width: 120px; line-height: 1">
	        {% if student.person.active == 0 %}
	            <strong class="text-error">УДАЛЕН</strong>
	        {% else %}
	            {% if student.last_comment %}{{ student.last_comment.text }}{% endif %}
	        {% endif %}
	    </td>
	</tr>
	{% endfor %} #} -->
	</table>

	<!-- Форма "Карточка ученика" -->
    <div id="editStudent" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 class="ib">Карточка ученика</h3><div class="alert ib" style="width: 200px; z-index: 9999;"></div>
        </div>
        <div class="form-horizontal" id="editStudentContent">
            <input type="hidden" name="stid" class="data" id="stid" />
            <div class="modal-body">
                <div class="control-group">
                    <label class="control-label" for="last_name">Фамилия</label>
                    <div class="controls">
                        <input type="text" class="data" name="last_name" id="last_name" required />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="first_name">Имя</label>
                    <div class="controls">
                        <input type="text" class="data" name="first_name" id="first_name" required />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="phone">Тел.</label>
                    <div class="controls">
                        <input type="tel" class="data" name="phone" id="phone" required />
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="e_mail">E-mail</label>
                    <div class="controls">
                        <input type="email" class="data" name="e_mail" id="e_mail" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn cancel" data-dismiss="modal" aria-hidden="true">Отмена</button>
                <input class="btn btn-primary" type="submit" value="Добавить" />
            </div>
        </div>
    </div>

<div class="form hidden">
    <div>
        <select name="gid">
            <option data-value="null" value="-1">-- выберите группу --</option>
            {% for group in groups %}
            <option data-value="{{group.name}}" value={{group.id}}>{{group.name}}</option>
            {% endfor %}
        </select>
        <select name="ptid">
            <option data-value="null" value="-1">-- выберите абонемент --</option>
            {% for pt in pass_types %}
            <option data-value="{{pt.name}}" value={{pt.id}}>{{pt.name}}</option>
            {% endfor %}
        </select>
        <button class="submit btn btn-primary" onclick="$(document).trigger('submit')">Добавить</button>
    </div>
</div>

{% endblock %}
