{% block head %}
{% endblock %}

{% block body %}

    {% block content %}

            <table class="table table-bordered table-striped table-hover">
                <tr class="shotcard-disabled">
                    <th class="info-fio"><input class="student-selector" type="checkbox" value="-1" /></th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Телефон</th>
                    <th>E-mail</th>
                    <th>ОРГ-статус</th>
                    <th>Остаток по абонементу</th>
                </tr>
                {% for student in group_detail.students %}
                <tr data-id="{{ student.person.id }}">
                    <td class="info-fio shotcard-disabled"><input class="shotcard-disabled" type="checkbox" value="{{ student.person.id }}" /></td>
                    <td>{{ student.person.last_name }}</td>
                    <td>{{ student.person.first_name }}</td>
                    <td>+{{ student.person.phone }}</td>
                    <td>{{ student.person.e_mail }}</td>
                    <td>{% if student.person.org %}ОРГ{% endif %}</td>
                    <td>{{ student.pass_remaining }}</td>
                </tr>
                {% endfor %}
            </table>
            <a id="editStudentBtn" role="button" class="btn" data-toggle="modal">Добавить</a>
            <a id="deleteStudentBtn" role="button" class="btn disabled">Удалить</a>
            <a id="freezePassBtn" role="button" class="btn disabled">Заморозить абонемент</a>

            <!-- Форма "Карточка ученика" -->
            <div id="editStudent" class="modal hide fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Карточка ученика</h3>
                </div>
                <form class="form-horizontal" action="/group/editStudent">
                    <input type="hidden" name="id" value="{{ group_detail.id }}" />
                    <div class="modal-body">
                            <div class="control-group">
                                <label class="control-label" for="last_name">Фамилия</label>
                                <div class="controls">
                                    <input type="text" name="last_name" id="last_name" required />
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label" for="first_name">Имя</label>
                                <div class="controls">
                                    <input type="text" name="first_name" id="first_name" required />
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label" for="phone">Тел.</label>
                                <div class="controls">
                                    <input type="tel" name="phone" id="phone" required />
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label" for="e_mail">E-mail</label>
                                <div class="controls">
                                    <input type="email" name="e_mail" id="e_mail" />
                                </div>
                            </div>
                            <div class="control-group">
                                <label class="control-label" for="is_org">ОРГ</label>
                                <div class="controls">
                                    <input type="checkbox" name="is_org" id="is_org" />
                                </div>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                        <input class="btn btn-primary" type="submit" value="Добавить" />
                    </div>
                </form>
            </div>

            <div id="passList" class="modal hide fade">
                <div class="modal-header"><h4></h4></div>
                <ul id="passListContainer"></ul>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
                    <input class="btn btn-primary" type="submit" value="Добавить" />
                </div>
            </div>

            <div id="shortCardMenu">
                <ul>
                    <li id="changeStudentData">Изменить</li>
                    <li id="deleteStudent">Удалить</li>
                    <li class="divider"></li>
                    <li id="freezeStudentPass">Заморозить абонемент</li>
                    <li id="changePassOwner">Передать абонемент</li>
                    <li id="writeOffPass">Списать абонемент</li>
                    <li id="deletePass">Удалить абонемент</li>
                </ul>
            </div>

    {% endblock %}

    {% block script %}

        <script type="text/javascript">
            (function() {
                /**
                 * Заполнение таблицы редактирования
                 * @type {*|jQuery|HTMLElement}
                 */

                var $infoTable = $('#info table'),
                    $studentForm = $('#editStudent'),
                    addUrl = '/group/addstudent',
                    editUrl = '/group/editstudent';

                var $shortCardMenu_lastIndex, $row, $id, $name, $family;
                var $groupId = {{ group_detail.id }};

                $infoTable.find('tr').click(function(event) {
                    if(!$(event.target).hasClass('shotcard-disabled') && $(event.target).parentsUntil('.shotcard-disabled').last().is('html')) {
                        event.stopPropagation();
                        $shortCardMenu = $('#shortCardMenu');
                        $shortCardMenu.css('top', event.clientY);
                        $shortCardMenu.css('left', event.clientX);
                        $id = $(this).data('id');

                        var chld = $(this).children();

                        $name = $(chld[1]).text();
                        $family = $(chld[2]).text();

                        $index = $(this).index();

                        function hide() {
                            $shortCardMenu.hide();
                            $shortCardMenu_lastIndex = null;
                            $('body').off('click', hide);
                        }

                        function show() {
                            $shortCardMenu_lastIndex = $index;
                            $shortCardMenu.show();
                        }

                        if($shortCardMenu_lastIndex == $index) {
                            hide();
                            $row = null;
                        } else {
                            show();
                            $('body').on('click', hide);
                            $row = $(this);
                        }


                    }
                });

                $('#changeStudentData').click(function() {
                    showStudentCard();
                });

                $('#deleteStudent').click(function() {
                    console.log('delete student');
                });

                $('#freezeStudentPass').click(function() {
                   console.log('freeze pass');
                });

                var $passList = $('#passList');
                $passList.modal({show: false});

                var passListHandler;

                $passList.find('.modal-footer .btn-primary').click(passListHandler);

                $('#writeOffPass').click(function() {
                    $passList.find('.modal-footer .btn-primary').val('Списать');
                    $passList.find('.modal-header h4').text($family+' '+$name);
                    processData('getpasses', {owner: $id, group: $groupId}, processPassList, writeOffProcess);
                });

                $('#deletePass').click(function() {
                    $passList.find('.modal-footer .btn-primary').val('Удалить');
                    $passList.find('.modal-header h4').text($family+' '+$name);
                    processData('getpasses', {owner: $id, group: $groupId}, processPassList, deleteProcess);
                });

                function processData(url, params, callback) {

                    $.ajax({
                        method: 'GET',
                        url: url,
                        data: params
                    }).error(function(err) {
                        callback(err, null)
                    }).done(function(data) {
                        callback(null, JSON.parse(data))
                    });
                }

                function processPassList(err, passes, buttonHandler) {
                    if(!err) {
                        var $pl = $('#passListContainer');
                        $pl.empty();

                        for(var i= 0, j= passes.length; i<j; i++) {
                            pass = passes[i];
                            $('<li><label class="checkbox"><input type="checkbox" data-val="'+pass.id+'">'+pass.pass_type.name+' c '+pass.start_date+'</label></li>').appendTo($pl);
                        }
                        $passList.modal('show');

                        passListHandler = buttonHandler;
                    }
                }

                function writeOffProcess() {

                    // todo собрать ID-шники и передать их для обработки

                    if(confirm('Списать абонемент(ы)')) {
                        processData('writeoffpass', {owner: $id, group: $groupId}, function() {
                            $passList.modal('hide');
                        });
                    }
                }

                function deleteProcess() {

                    // todo собрать ID-шники и передать их для обработки

                    if(confirm('Удалить абонемент(ы)')) {
                        processData('deletepass', {owner: $id, group: $groupId}, function() {
                            $passList.modal('hide');
                        });
                    }
                }

                function showStudentCard(event) {
                    var $this = $row,
                    $children = $this.children();

                    $('#last_name').val($($children[1]).text());
                    $('#first_name').val($($children[2]).text());
                    $('#phone').val($($children[3]).text());
                    $('#e_mail').val($($children[4]).text());
                    $('#is_org').prop('checked', $($children[5]).text() == 'ОРГ' ? 'checked' : false);

                    $studentForm.find('form').attr('action', editUrl);
                    $studentForm.find('.btn.btn-primary').val('Сохранить');
                    $studentForm.modal('show');
                }

                $('#editStudentBtn').click(function() {

                    $('#last_name').val('');
                    $('#first_name').val('');
                    $('#phone').val('');
                    $('#e_mail').val('');
                    $('#is_org').prop('checked', false);

                    $studentForm.find('form').attr('action', addUrl);
                    $studentForm.find('.btn.btn-primary').val('Добавить');
                    $studentForm.modal('show');
                });

                /**
                 * checkbox
                 */
                var $inputs = $('.info-fio input'),
                    checkAllValue = -1;

                $inputs.click(function() {
                    var $this = $(this),
                        $val = $this.val();

                    if($val == checkAllValue) {

                        if($this.prop('checked')) {
                            $inputs.each(function() {
                                $(this).prop('checked', 'checked');
                                $('#deleteStudentBtn').removeClass('disabled');
                            });
                        } else {
                            $inputs.each(function() {
                                $(this).prop('checked', false);
                            });
                        }
                    } else {
                        var $checked = $inputs.filter(':checked'),
                            $target = $inputs.filter('[value='+checkAllValue+']');
                        if($checked.length == $inputs.length-1 && !($target.prop('checked'))) {
                            $target.prop('checked','checked')
                        } else {
                            $target.prop('checked',false)
                        }
                    }

                    if($inputs.filter(':checked').length > 0) {
                        $('#deleteStudentBtn').removeClass('disabled');
                        $('#freezePassBtn').removeClass('disabled');
                    } else {
                        $('#deleteStudentBtn').addClass('disabled');
                        $('#freezePassBtn').addClass('disabled');
                    }
                });
            })();
        </script>

    {% endblock %}

{% endblock %}