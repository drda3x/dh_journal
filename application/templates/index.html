{% extends "base.html" %}
{% block head%}
  <!-- Шаблон для региона -->
 <script id="region-template" type="text/template">
  <div class="region-title">
    <h3><%= title %><a href="">свернуть</a></h3>
  </div>
  <div class="region-content">
    <%= content %>
  </div>
 </script>

 <!-- Общий вид таблицы --> 
<script id="table-main" type="text/template">
    <h4><%= title %></h4>
    <table class="table table-hover">
    </table>
    <div class="link-container">
        <a href="">--показать закрытые--</a>
    </div>
 </script>

 <!-- Строка таблицы для группы -->
 <script id="group-table-row" type="text/template">
    <td class="col-md-3"><%= name %>
        <% if (!is_opened) {%>
            <br><strong style="margin-left: 5px;" class="text-danger">ЗАКРЫТА</strong>
        <% } %>
    </td>
    <td class="col-xs-3"><%= dance_hall.station %></td>
    <td class="col-xs-3 hidden-xs"><%= days %></td>
    <td class="col-xs-3"><%= time %></td>
 </script>

 <!-- Строка таблицы для открытого урока -->
 <script id="mk-table-row" type="text/template">
    <td class="col-md-4"><%= date %></td>
    <td class="col-md-4"><%= dance_hall.station %></td>
    <td class="col-md-4"><%= time %></td>
 </script>

<!-- Регион должников -->
<script id="debtors-main" type="text/template">
    <h4 class="hidden-xs"><%= title %></h4>
    <table class="table table-hover hidden-xs">
        <tr>
            <th>Фамилия</th>
            <th>Имя</th>
            <th>Телефон</th>
            <th>Кол-во занятий</th>
        </tr>
    </table>
</script>

<!-- Один должник -->
<script id="debtors-one-debtor" type="text/template">
    <td><%= surname %></td>
    <td><%= name %></td>
    <td><%= phone %></td>
    <td><%= count %></td>
</script>

 {% endblock%}
 {% block body %}

   <script type="text/javascript">
    (function() {
        "use strict"

        // Главная вьюшка на странице
        var PageRegion = Backbone.View.extend({
            template: $("#region-template").html(),

            tagName: "div",
            className: "row-fulid col-md-6",

            render: function(_views) {
                var views = (_views instanceof Array) ? _views : [_views];
                
                _.each(views, $.proxy(function(item) {
                    this.$el.append(item.render().el);
                }, this));

                $('#container').append(this.$el);
                return this;
            }
        });

        var Group = Backbone.Model.extend({
            defaults: {
                url: '/group?id='
            }
        });
        var MK = Backbone.Model.extend({
            defaults: {
                url: '/mk?id='
            }
        });
        var Groups = Backbone.Collection.extend({model: Group});
        var MKs = Backbone.Collection.extend({model: MK});

        var TableRow = Backbone.View.extend({
            tagName: 'tr',
            template: function() {
                throw('Realize this function');
            },
            className: 'pointer',

            events: {
                "click": "on_click"
            },

            render: function() {
                this.$el.html(this.template(this.model.toJSON())); 
                return this;
            },
            
            on_click: function() {
                window.location.assign(this.model.get('url') + this.model.get('id'));
            }
        });

        var TableView = Backbone.View.extend({
            tagName: 'div',
            className: 'border',
            table_template: _.template($("#table-main").html()),
            row_class: TableRow,

            render: function(title, data) {
                if(this.collection.models.length > 0) {
                    this.$el.html(
                        this.table_template({title: this.options.title})
                    ); 
                    
                    var table = $(this.$el).find('table');

                    _.each(this.collection.models, $.proxy(function(item) {
                        var row = new this.row_class({model: item});
                        table.append(row.render().el);
                    }, this));
                }

                return this;
            }
        });

        var GroupTableRow = TableRow.extend({
            template: _.template($("#group-table-row").html())
        });

        var MkTableRow = TableRow.extend({
            template: _.template($("#mk-table-row").html())
        });

        var GroupTableView = TableView.extend({
            row_class: GroupTableRow
        });

        var MkTableView = TableView.extend({
            row_class: MkTableRow
        });
        
        // Должники 
        var Debtor = Backbone.Model.extend({});

        var Debtors = Backbone.Collection.extend({
            model: Debtor 
        });

        var OneDebtorView = TableRow.extend({
            template: _.template($("#debtors-one-debtor").html())/*,
            render: function() {
                this.$el.html(this.template(this.model.toJSON()));  
                return this;
            }
            */
        });
        
        var DebtorsView = TableView.extend({
            table_template: _.template($("#debtors-main").html()),
            row_class: OneDebtorView 
        });
        
        /*
        var DebtorsView = Backbone.View.extend({
            template: _.template($('#debtors-main').html()),

            initialize: function() {
                this.render();
                return this;
            },

            render: function() {
                this.$el.html(this.template());  

                _.each(this.collection.models, $.proxy(function(item) {
                    var elem = new OneDebtorView({model: item});
                    this.$el.append(elem.render().$el); 
                }, this));

                return this;
            }
        });
        */

        new PageRegion().render([
            new GroupTableView({
                title: "Начинающие", 
                collection: new Groups({{ beginners | safe }})
            }).render(),

            new GroupTableView({
                title: "Продолжающие", 
                collection: new Groups({{ inter | safe}})
            }).render(),

            new GroupTableView({
                title: "Конкурсные", 
                collection: new Groups({{ advanced | safe}})
            }).render(),

            new GroupTableView({
                title: "Без уровня", 
                collection: new Groups({{ no_level | safe}})
            }).render(),

            new MkTableView({
                title: "Открытые уроки",
                collection: new MKs({{ mk | safe}})
            })
        ]);

        new PageRegion().render([
                new DebtorsView({
                    title: "Должники",
                    collection: new Debtors({{ debtors | safe }})
                })
        ]);

    })(jQuery)
 </script>

{% endblock %}
