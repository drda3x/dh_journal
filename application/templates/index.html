{% extends "base.html" %}
{% block head%}
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/css/main_page.css">

  <!-- Шаблон для региона -->
 <script id="region-template" type="text/template">
  <div class="region-title">
    <h3><%= title %><a href="">свернуть</a></h3>
  </div>
  <div class="region-content">
    <%= content %>
  </div>
 </script>

 <!-- Общий вид таблицы -->
 <script id="table-main" type="text/template">
    <h4><%= title %></h4>
    <table class="table table-striped table-hover">
    </table>
 </script>

 <!-- Строка таблицы -->
 <script id="table-row" type="text/template">
    <td><%= dance_hall.station %></td>
    <td><%= days %></td>
    <td><%= time %></td>
 </script>

 {% endblock%}
 {% block body %}
    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container-fluid">
                <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>
                <a href="#" class="brand">ТСК "Динамика". Электронный журнал</a>

                <div class="nav-collapse collapse">
                    <div class="pull-right dropdown header-right" style="position: relative">
                        <a class="navbar-link dropdown-toggle" href="#" data-toggle="dropdown" role="button" type="button">{{ user.last_name }} {{ user.first_name }}<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="profile?uid={{ user.id }}" id="userProfile" tabindex="-1">Профиль</a></li>
                            <li><a href="logout" tabindex="-1">Выход</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div id="container" class="container">
    </div>

   <script type="text/javascript">
    (function() {
        "use strict"

        // Главная вьюшка на странице
        var PageRegion = Backbone.View.extend({
            template: $("#region-template").html(),

            tagName: "div",
            className: "row-fulid",

            render: function(_views) {
                var views = (_views instanceof Array) ? _views : [_views];
                
                _.each(views, $.proxy(function(item) {
                    this.$el.append(item.render().el);
                }, this));

                $('#container').append(this.$el);
                return this;
            }
        });

        var Group = Backbone.Model.extend({});
        var Groups = Backbone.Collection.extend({model: Group});

        var TableRow = Backbone.View.extend({
            tagName: 'tr',
            template: _.template($("#table-row").html()),
            className: 'pointer',

            events: {
                "click": "on_click"
            },

            render: function() {
                this.$el.html(this.template(this.model.toJSON())); 
                return this;
            },
            
            on_click: function() {
                window.location.assign('/group?id=' + this.model.get('id'));
            }
        });

        var TableView = Backbone.View.extend({
            tagName: 'div',
            className: 'border',
            table_template: _.template($("#table-main").html()),

            render: function(title, data) {
                this.$el.html(
                    this.table_template({title: this.options.title})
                ); 
                
                var table = $(this.$el).find('table');
                _.each(this.collection.models, $.proxy(function(item) {
                    var row = new TableRow({model: item});
                    table.append(row.render().el);
                }, this));

                return this;
            }
        });

        new PageRegion().render([
            new TableView({
                title: "Начинающие", 
                collection: new Groups({{ beginners | safe }})
            }).render(),

            new TableView({
                title: "Продолжающие", 
                collection: new Groups({{ inter | safe}})
            }).render(),

            new TableView({
                title: "Конкурсные", 
                collection: new Groups({{ advanced | safe}})
            }).render(),

            new TableView({
                title: "Без уровня", 
                collection: new Groups({{ no_level | safe}})
            }).render()
        ]);

    })(jQuery)
 </script>
{% endblock %}
