{% extends "base.html" %}
{% block head %}
    <link rel="stylesheet" href="../static/css/club_card.css" />
{% endblock %}
{% block body %}
    {% block content %}
    <div class="header">
        <a href="#multicard-add-menu" role="button" data-toggle="modal" class="btn btn-primary">Добавить</a>
        <div id="dateControl" class="dropdown">
            <strong class="text-info">
                Месяц:
            </strong>
                <a class="navbar-link dropdown-toggle" href="#" data-toggle="dropdown">
                    {{ control_data.constant.current_date_str }}
                </a>
                <b class="caret"></b>
            <ul class="dropdown-menu usr">
                {% for month in control_data.date_control %}
                    <li><a href="/clubcards?date={{ month.val }}" tabindex="-1">{{ month.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <table id="all_passes" class="table table-bordered table-striped table-hover">
        <tr>
            <th>№</th>
            <th>Фамилия Имя</th>
            <th>Дата начала</th>
            <th>Дата окончания</th>
            <th>Преподаватель</th>
            <th>Остаток</th>
        </tr>
        {% for p in passes %}
            <tr data-pid="{{ p.id }}" data-stid="{{ p.student.id }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ p.student.last_name }} {{ p.student.first_name }}</td>
                <td>{{ p.start_date }}</td>
                <td>{{ p.end_date }}</td>
                <td>{{ p.opener.last_name }} {{ p.opener.first_name }}</td>
                <td>{{ p.lessons }}</td>
            </tr>
        {% endfor %}
    </table>

    <div id="multicard-add-menu" class="modal hide">
        <div class="modal-header">
            <h4>Добавление клубной карты</h4>
        </div>
        <div class="content">
            <div class="groups">
                <h4>Группа</h4>
                <ul>
                    {% if user.is_superuser %}<strong>Мои группы:</strong>{% endif %}
                {% for group in groups.self %}
                    <li data-id="{{ group.id }}">{{ group.name }} - {{ group.days }}</li>
                {% endfor %}
                    {% if user.is_superuser %}
                        <br>
                        <strong>Других преподов:</strong>
                    {% endif %}
                {% for group in groups.other %}
                    <li data-id="{{ group.id }}">{{ group.t1 }} {{ group.t2 }} - {{ group.name }} - {{ group.days }}</li>
                {% endfor %}
                </ul>
            </div>
            <div class="students_lists">
                <h4>Ученик</h4>
                {% for group in students %}
                    <ul id="{{ group.id }}" class="hide">
                        {% for student in group.list %}
                            <li data-stid="{{ student.id }}">{{ student.last_name }} {{ student.first_name }}</li>
                        {% endfor %}
                    </ul>
                {% endfor %}
            </div>
            <div class="datepicker">
                <h4>Дата</h4>
                <input type="text" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
            <button class="btn btn-primary save_data" data-dismiss="modal" aria-hidden="true">Добавить</button>
        </div>
    </div>

    <div id="multicard-pass-menu" class="modal hide">
        <div class="modal-header">
            <h4></h4>
        </div>
        <div>
            <div class="groups">
                <h4>Группа</h4>
                <ul>
                {% if user.is_superuser %}<strong>Мои группы:</strong>{% endif %}
                {% for group in groups.self %}
                    <li data-id="{{ group.id }}" class="{{ group.students }} hide">{{ group.name }} - {{ group.days }}</li>
                {% endfor %}
                {% if user.is_superuser %}
                    <br>
                    <strong>Других преподов:</strong>
                {% endif %}
                {% for group in groups.other %}
                    <li data-id="{{ group.id }}" class="{{ group.students }} hide">{{ group.t1 }} {{ group.t2 }} - {{ group.name }} - {{ group.days }}</li>
                {% endfor %}
                </ul>
            </div>
            <div class="dates">
                <h4>Дата</h4>
                <ul>
                    {% for lst in date_list %}
                        <li class="{{ lst.val }} hide">{{ lst.label }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger delete_pass" data-dismiss="modal">Удалить абонемент</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Отмена</button>
            <button class="btn btn-primary save_data" data-dismiss="modal" aria-hidden="true">Списать занятие</button>
        </div>
    </div>

    {% endblock %}
    {% block script %}

    <script type="text/javascript">
    (function() {
        $('.modal .groups li').click(function() {

            var $this = $(this),
                $id = $this.data('id');
            $('.modal .students_lists ul').addClass('hide');
            $('.modal .students_lists ul#'+$id).removeClass('hide');
        });

        $('.modal li').click(function() {
            var $this = $(this);
            if($this.parents('.groups').length > 0) {
                $('.modal .students_lists li').removeClass('active');
            }
            $this.siblings().removeClass('active');
            $this.addClass('active');
        });

        var datepicker = $('#multicard-add-menu .datepicker input').datepicker({
            format: 'dd.mm.yyyy',
            weekStart: 1
        });

        $('#multicard-add-menu .save_data').click(function() {
            var group = $('.groups').find('.active').first().data('id'),
                student = $('.students_lists').find('.active').first().data('stid'),
                date = datepicker.val();

            $.ajax('createmulty', {
                data: {
                    group: group,
                    student: student,
                    date: date
                }
            }).done(function() {
                window.location.reload();
            }).error(function() {
                console.log('error');
            })
        });

        var pass, student, group;

        $('#all_passes tr').click(function() {

            var $this = $(this);
            pass = $this.data('pid');
            student = $this.data('stid');

            $('#multicard-pass-menu h4').first().text($($this.children()[1]).text());
            $('#multicard-pass-menu .groups li').addClass('hide');
            $('#multicard-pass-menu .groups .s'+student).removeClass('hide');

            $('#multicard-pass-menu').modal('show');

        });

        $('#multicard-pass-menu .groups').click(function(event) {
            var $this = $(event.target);
            group = $this.data('id');

            $('#multicard-pass-menu .dates li').addClass('hide');
            $('#multicard-pass-menu .dates .g'+group+'p'+pass).removeClass('hide');
        });

        $('#multicard-pass-menu').on('hide', function() {
            $('#multicard-pass-menu h4').first().text('');
            $('#multicard-pass-menu .active').removeClass('active');
            $('#multicard-pass-menu .dates li').addClass('hide');
        });

        $('#multicard-pass-menu .save_data').click(function() {
            var $date = $('#multicard-pass-menu .dates .active').text(),
                json = {
                    group_id: group,
                    date: $date,
                    checked: [{
                        pass_id: pass
                    }]
                };

            $.ajax('processlesson', {
                data: {
                    data: JSON.stringify(json)
                }
            }).done(function() {
                window.location.reload();
            }).error(function(err) {
                console.log(err.responseText);
            });
        });

        $('#multicard-pass-menu .delete_pass').click(function() {
            $.ajax('deletemultypass', {
                data: {
                    ids: JSON.stringify([pass])
                }
            }).done(function() {
                window.location.reload();
            }).error(function(err) {
                console.log(err.responseText);
            });
        });

    })();
    </script>

    {% endblock %}
{% endblock %}